import{xApp}from"./xapp.js";class HtmlFetchDeps{constructor(){this.scripts=[],this.styles=[]}empty(){for(;0<this.scripts.length;){const a=this.scripts.pop();a.remove()}for(;0<this.styles.length;){const a=this.styles.pop();a.remove()}}pushScript(a){this.scripts.push(a)}pushStyle(a){this.styles.push(a)}}xApp.htmlFetchDeps=function(){return new HtmlFetchDeps};const _layout_loads=xApp.htmlFetchDeps(),_page_loads=xApp.htmlFetchDeps(),_unload_scripts=[],_hashchange_scripts=[],_reg_elements=[];xApp.pageReff=null;let _layout=null;xApp.onUnload=function(a){_unload_scripts.push(a)},xApp.pushRemovedElements=function(a){_reg_elements.push(a)},xApp.installScripts=function(...a){return new Promise((b,c)=>{const d=function(){if(0<a.length){const b=document.createElement("script"),e=a.shift();b.type="text/javascript",b.onload=d,b.onerror=c,b.src=e,document.head.appendChild(b),_page_loads.pushScript(b)}else b()};d()})},xApp.installStyles=function(...a){return new Promise((b,c)=>{const d=function(){if(0<a.length){const b=document.createElement("link"),e=a.shift();b.onerror=c,b.href=e,b.rel="stylesheet",document.head.appendChild(b),_page_loads.pushStyle(b),d()}else b()};d()})},xApp.onHashchange=function(a){_hashchange_scripts.push(a),addEventListener("hashchange",a)},xApp.block=function(){let a=document.querySelector(".xapp-overlay");const b=document.body;if(null!=a)a.setAttribute("aria-hidden",!1);else{let c=document.createElement("div");c.innerHTML="<section class=\"xapp-overlay\" aria-hidden=\"false\"><div></div></section>",a=c.firstElementChild,b.appendChild(a),c=null}b.classList.add("xapp-noscroll"),a.scrollTop=0},xApp.unblock=function(){let a=document.querySelector(".xapp-overlay");null!=a&&(a.setAttribute("aria-hidden",!0),document.body.classList.remove("xapp-noscroll"))};function installLoads(a,b,c,d){const e=a.querySelectorAll("link[rel=\"stylesheet\"], style"),f=e.length,g=function(a,b,c){if(a.href){const d=document.createElement("link");if(d.onload=c,d.onerror=c,d.href=a.href,d.rel=a.rel,"nth"in a.dataset){const b=document.head.querySelectorAll("link[rel=\"stylesheet\"]"),c=Number.parseInt(a.dataset.nth,10);Number.isNaN(c)?document.head.appendChild(d):c>b.length-1||0>c?document.head.appendChild(d):b[c].parentNode.insertBefore(d,b[c])}else document.head.appendChild(d);b.pushStyle(d),a.parentNode.removeChild(a)}else b.pushStyle(a),c()},h=function(a,b,c){"undefined"==typeof c&&(c=0),a[c](function(){c++,c===a.length?b():h(a,b,c)})},i=function(){const b=document.createEvent("Event");b.initEvent("DOMContentLoaded",!0,!0),document.dispatchEvent(b),d(),a=null},j=function(a,b,c){const d=document.createElement("script");a.type&&(d.type=a.type),a.src?(d.onload=c,d.onerror=c,d.src=a.src):d.textContent=a.innerText,document.head.appendChild(d),b.pushScript(d),a.parentNode.removeChild(a),a.src||c()},k=function(){a.childNodes.forEach(a=>{1==a.nodeType&&"SCRIPT"!=a.nodeName&&b.appendChild(a)});const e=a.querySelectorAll("script"),f=[];[].forEach.call(e,function(a){f.push(function(b){j(a,c,b)})}),0<f.length?h(f,i):(d(),a=null)};if(0<f){let a=0;[].forEach.call(e,function(b){g(b,c,function(){a++,a==f&&k()})})}else k()}xApp.loadPage=function(a,b,c,d){const e={Accept:"text/html"},f=localStorage.getItem("access_token"),g=xApp.basePath+a;null!=f&&(e.Authorization="Bearer "+f),fetch(g,{headers:e}).then(a=>{if(!!a.ok)return a.text();else if(401==a.status)try{return xApp.refreshToken(async()=>{e.Authorization="Bearer "+localStorage.getItem("access_token");const a=await fetch(g,{headers:e});return a.text()})}catch(a){return xApp.pageReff=location.hash,void(location="#!/login")}else switch(a.status){case 400:return;default:return a.text();}}).then(a=>{const e=document.createElement("div"),f=document.querySelector(b);e.innerHTML=a;let g=null,h=e.firstElementChild;if(h.hasAttribute("id"))g=h.id;else for(;null!=h.nextElementSibling;)if(h=h.nextElementSibling,h.hasAttribute("id")){g=h.id;break}installLoads(e,f,c,function(){d(f,g)})}).catch(a=>{xApp.notifyError(a)})};const route=function(){let a=location.hash.split("?"),b=a[0].match(/^#!((?:\/[a-zA-Z0-9]+(?:_[a-zA-Z0-9]+)*(?:\-[a-zA-Z0-9]+)*)+)$/),c=null==b?"":b[1];if(""!=c){let b=2==a.length?a[1]:"",d=function(){let a={};if(""!=b&&null!=b.match(/^(([a-zA-Z0-9_]+\=[a-zA-Z0-9_]*)+?(?:\&[a-zA-Z0-9_]+\=[a-zA-Z0-9_]*)*)$/)){let c=b.split("&");c.forEach(b=>{b=b.split("="),a[b[0]]=decodeURI(b[1]||"")})}xApp.query=a};if("undefined"!=typeof xApp.path&&c!==xApp.path||"undefined"==typeof xApp.path){const a=document.querySelector(xApp.appSelector),b=xApp.basePath+xApp.routerBasePath+"/pages"+c;xApp.query={},xApp.reloadApp=function(a){if(!0===a){const a={Accept:"text/html"},c=localStorage.getItem("access_token");null!=c&&(a.Authorization="Bearer "+c);const e=new Request(b,{headers:a});for(xApp.block();0<_unload_scripts.length;){const a=_unload_scripts.pop();a()}for(;0<_hashchange_scripts.length;){const a=_hashchange_scripts.pop();removeEventListener("hashchange",a)}fetch(e).then(c=>{if(!!c.ok)return c.text();else if(401==c.status)try{return xApp.refreshToken(async()=>{a.Authorization="Bearer "+localStorage.getItem("access_token");const c=await fetch(b,{headers:a});return c.text()})}catch(a){return xApp.pageReff=location.hash,void(location="#!/login")}else return c.text()}).then(a=>{const b=document.createElement("div");b.innerHTML=a;const c=b.querySelector("[data-layout]");let e="";for(null!=c&&(e=c.dataset.layout),_page_loads.empty();0<_reg_elements.length;){const a=_reg_elements.pop();a.parentNode.removeChild(a)}if(""!=e){const a=function(){const a=document.querySelector("#container");for(;a.hasChildNodes();)a.removeChild(a.lastChild);installLoads(b,a,_page_loads,function(){d(),xApp.unblock()})};_layout==e?a():fetch(xApp.basePath+xApp.routerBasePath+"/layout/"+e,{headers:{Accept:"text/html"}}).then(a=>a.text()).then(b=>{const c=document.createElement("div");c.innerHTML=b,_layout_loads.empty();const d=document.querySelector(xApp.appSelector);for(;d.hasChildNodes();)d.removeChild(d.lastChild);installLoads(c,d,_layout_loads,a),_layout=e}).catch(a=>{console.log(a)})}else{_layout_loads.empty();const a=document.querySelector(xApp.appSelector);for(;a.hasChildNodes();)a.removeChild(a.lastChild);installLoads(b,a,_layout_loads,function(){d(),_layout=null,xApp.unblock()})}}).catch(()=>{})}else;},xApp.reloadApp(!0)}else d()}else location="#!/default";xApp.path=c};addEventListener("hashchange",route),route();